# Review: End-to-End UI Testing

**Date:** 2026-02-19
**Method:** Playwright MCP browser testing across all screens and workflows
**Scope:** Full application E2E test — all pages, user flows, edge cases, responsive behavior, UI assessment

## Pages Tested

| Page | Route | Status |
|------|-------|--------|
| Timeline | `/` | Pass |
| Post view | `/post/*` | Pass |
| About page | `/page/about` | Pass |
| Search | `/search?q=...` | Pass |
| Login | `/login` | Pass |
| Labels list | `/labels` | Pass |
| Label graph | `/labels/graph` | Pass |
| Label posts | `/labels/:id` | Pass |
| Label settings | `/labels/:id/settings` | Pass |
| Editor (new) | `/editor/new` | Pass |
| Editor (edit) | `/editor/*` | Pass |

## Bugs Found and Fixed

### 1. Excerpts were plain text instead of rendered markdown

Timeline card excerpts were stripped of all markdown formatting. Math (`$E = mc^2$`), bold, inline code, and links all appeared as raw text.

**Root cause:** `generate_excerpt()` stripped all markdown syntax to produce plain text. The `PostCache` model only stored this plain-text excerpt.

**Fix:** Added `rendered_excerpt` field to `PostCache` — a Pandoc-rendered HTML excerpt generated from a markdown-preserving truncation (`generate_markdown_excerpt()`). Removed the plain-text `excerpt` field from `PostCache`, `PostSummary`, and `SearchResult`. The rendered excerpt is used everywhere: timeline cards, search results, and post detail. KaTeX math in excerpts is processed client-side by `useRenderedHtml`.

**Files changed:**
- `backend/filesystem/frontmatter.py` — replaced `generate_excerpt()` with `generate_markdown_excerpt()`
- `backend/models/post.py` — replaced `excerpt` with `rendered_excerpt`; removed `excerpt` from FTS table
- `backend/schemas/post.py` — replaced `excerpt` with `rendered_excerpt` in `PostSummary` and `SearchResult`
- `backend/services/cache_service.py` — generate rendered excerpt via Pandoc during cache rebuild
- `backend/services/post_service.py` — map `rendered_excerpt` in list and search queries
- `backend/api/posts.py` — generate rendered excerpt in create/update endpoints; updated FTS helpers
- `frontend/src/api/client.ts` — replaced `excerpt` with `rendered_excerpt` in TypeScript types
- `frontend/src/components/posts/PostCard.tsx` — use `rendered_excerpt` with `useRenderedHtml`
- `frontend/src/pages/SearchPage.tsx` — render search excerpts as HTML
- `frontend/src/index.css` — added `.prose-excerpt` styles for rendered excerpt HTML

### 2. Auth redirect race condition on protected pages

Navigating directly to `/labels/:id/settings` or `/editor/*` while authenticated would flash-redirect to `/login` because `checkAuth()` hadn't completed yet.

**Root cause:** Protected pages checked `if (!user)` and redirected, but `checkAuth()` in `App.tsx` is async — `user` is initially `null` before the token is validated.

**Fix:** Added `isInitialized: boolean` to `authStore`. Protected pages now check `isInitialized && !user` before redirecting, and render nothing while initialization is pending.

**Files changed:**
- `frontend/src/stores/authStore.ts` — added `isInitialized` flag
- `frontend/src/pages/LabelSettingsPage.tsx` — wait for initialization
- `frontend/src/pages/EditorPage.tsx` — wait for initialization

### 3. Editor accessible to unauthenticated users

`/editor/new` and `/editor/*` loaded the full editor form for logged-out users. Save would fail with 401, but the page should not be accessible.

**Fix:** Added auth guard to `EditorPage.tsx` using the same `isInitialized && !user` redirect pattern.

### 4. Post CRUD did not maintain label cache or FTS index

Creating, updating, or deleting posts via the API didn't update `post_labels_cache` or `posts_fts` tables. Only `rebuild_cache()` at startup populated them.

**Root cause:** The CRUD endpoints wrote to `posts_cache` and the filesystem but skipped the auxiliary tables.

**Fix:** Added helper functions in `backend/api/posts.py`:
- `_sync_post_labels()` — replaces `post_labels_cache` entries for a post
- `_insert_post_fts()` — inserts a new FTS5 index entry
- `_delete_post_fts()` — removes an FTS5 entry using the special `'delete'` command with explicit old values (required because the `posts_fts` content-sync table references a non-existent `content` column in `posts_cache`)

Called from `create_post_endpoint`, `update_post_endpoint`, and `delete_post_endpoint`.

### 5. Duplicate post creation returned 500

Creating a post with an already-existing file path caused an unhandled `IntegrityError` (500 Internal Server Error).

**Fix:** Added existence check at the start of `create_post_endpoint`, returning 409 with "A post with this file path already exists". Frontend updated to show contextual error message for 409 on create vs update.

**Files changed:**
- `backend/api/posts.py` — duplicate check before insert
- `frontend/src/pages/EditorPage.tsx` — contextual 409 error message

## Edge Cases Verified

| Scenario | Result |
|----------|--------|
| 404 post URL | "Post not found" with back link |
| 404 label URL | "Label not found" with back link |
| 404 page URL | "Failed to load page" message |
| Empty search results | "No results found" |
| Invalid file path on create | Validation error from backend pattern check |
| Duplicate file path on create | 409 "A post with this file path already exists" |
| Edit nonexistent post | "Post not found" error in editor |
| Unauthenticated editor access | Redirects to login |
| Unauthenticated label settings access | Redirects to login |
| Logout clears UI | Write/Edit buttons removed, Login shown |
| Mobile responsive (375px) | All pages render correctly |

## UI Design Assessment

### Strengths

- **Typography:** Excellent font pairing — Instrument Serif (display) + DM Sans (body) + JetBrains Mono (code). Distinctive and refined, avoids generic choices.
- **Color palette:** Warm paper tones (`#faf8f5`, `#f5f0ea`) with terracotta accent (`#c44b2b`). Editorial, premium feel. Cohesive throughout.
- **Code blocks:** Catppuccin Mocha palette on dark background with full Pandoc syntax highlighting — well-considered.
- **Prose styling:** Generous line-height (1.75), proper heading hierarchy, tasteful blockquote and table styling.
- **Animations:** Subtle fade-in with translateY. Stagger delay classes available for orchestrated reveals.
- **Filter panel:** OR/AND label toggle, label search, date range pickers, author filter, clear all — powerful yet clean.
- **Label graph:** React Flow with Dagre auto-layout works well, including on mobile.
- **Responsive:** All pages function correctly at 375px mobile width with no broken layouts.

### Suggestions for Improvement

1. **No post delete in UI** — The `DELETE /api/posts/{path}` endpoint exists but there is no delete button in the frontend. Add a delete option in the editor toolbar or post view with a confirmation dialog.
2. **Editor 404 state** — When editing a nonexistent post path, the error appears inline but the empty editor form still renders below. Should show a prominent error state without the form.
3. **Post list initial load flash** — On the timeline, posts appear after a brief delay during which only the Filters button is visible. Consider a skeleton loader or spinner.
4. **Search page has no refinement input** — The search results page displays results but has no input field to refine the query. Users must use the header search button to start over.
5. **Logout button ambiguity** — The logout button uses an arrow icon without a text label on desktop. Could benefit from a tooltip.

## Validation

```
just check: all passing
  Backend:  mypy clean, ruff clean, 258 tests passed
  Frontend: tsc clean, eslint clean, 52 tests passed
```
